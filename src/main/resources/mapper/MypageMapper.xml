<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hello.market.repository.mybatis.myPage.MyPageMapper">
    <select id="select_deliveryAddr" resultType="Complete_deliveryInfo">
        select amount ->> #{purchase_id} purchaseAmount,
        json_unquote(json_extract(delivery_status,CONCAT(#{purchase_id},"[0]"))) deliveryMethod,
        json_unquote(json_extract(delivery_status,CONCAT(#{purchase_id},"[1]"))) deliveryMsg,
        json_unquote(json_extract(delivery_status,CONCAT(#{purchase_id},"[2]"))) deliveryStatus,
        a.*
        from purchase,(
        select firstName, lastName, mainAddr, detailAddr, postNum, tel
        from Purchase, json_table(delivery_list->>#{purchase_id},"$" columns(
        firstName varchar(20) PATH '$.first_name',
        lastName varchar(100) PATH '$.last_name',
        mainAddr varchar(50) PATH '$.main_addr',
        detailAddr varchar(50) PATH '$.detail_addr',
        postNum varchar(50) PATH '$.post_num',
        tel varchar(15) PATH '$.tel'
        ))tmp)a
        where user_id =#{user_id};
    </select>
    <select id="select_purchaseList" resultType="Cart">
        select pa.id productNo,
            pl.quantity,
            pa.title,
            json_unquote(json_extract(option_size,concat("$.option[",pl.option_no,"][0]"))) optionTitle
        from (select json_key, SUBSTRING_INDEX(json_key,"x",1) as single_multiple,
            SUBSTRING_INDEX(SUBSTRING_INDEX(json_key,"x",2),"x",-1) as product_no,
            SUBSTRING_INDEX(json_key,"x",-1) as option_no,
            json_extract(purchase_list,concat(#{purchase_id},".",json_key,'[0]')) quantity
            from Purchase, json_table(JSON_KEYS(purchase_list->> #{purchase_id}),"$[*]" columns(
            json_key varchar(20) PATH "$"
            ))tmp
        where user_id = #{user_id}
        )pl inner join Product_artist pa on pl.product_no = pa.id;
    </select>
</mapper>